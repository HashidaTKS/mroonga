%define mysql_version 5.5.12
%define mysql_release 1
%define mysql_dist    rhel5

Name:		mysql-groonga
Version:	@VERSION@
Release:	0%{?dist}
Summary:	A MySQL storage engine powered by groonga.

Group:		Applications/Databases
License:	LGPLv2.1
URL:		http://mroonga.github.com/
Source0:	http://github.com/downloads/mroonga/mroonga/groonga-storage-engine-%{version}.tar.gz

BuildRoot:      %{_tmppath}/%{name}-%{version}-%{release}-%(%{__id_u} -n)
BuildRequires:	groonga-devel
BuildRequires:	wget
Requires:	groonga-libs
Requires:	MySQL-server = %{mysql_version}-%{mysql_release}
Requires:	MySQL-client = %{mysql_version}-%{mysql_release}

%description
Groonga storage engine is a MySQL storage plugin.

%prep
%setup -q -n groonga-storage-engine-%{version}
mysql_full_version=%{mysql_version}-%{mysql_release}.%{mysql_dist}
srpm=MySQL-${mysql_full_version}.src.rpm
if [ ! -f ../../SRPMS/$srpm ]; then
    mysql_download_base=http://ftp.jaist.ac.jp/pub/mysql/Downloads/MySQL-5.5
    wget -O ../../SRPMS/$srpm $mysql_download_base/$srpm
    rpm -Uvh ../../SRPMS/$srpm
    for package in client devel embedded server shared test; do
        rpm=MySQL-${package}-${mysql_full_version}.%{_arch}.rpm
	mkdir -p ../../RPMS/%{_arch}
	if [ ! -f ../../RPMS/%{_arch}/$rpm ]; then
            wget -O ../../RPMS/%{_arch}/$rpm $mysql_download_base/$rpm
	fi
    done
fi
if ! rpm -q MySQL-devel 2>&1 | grep $mysql_full_version > /dev/null; then
    rpm=../../RPMS/%{_arch}/MySQL-devel-$mysql_full_version.%{_arch}.rpm
    sudo rpm -Uvh $rpm || \
	echo "install MySQL-devel by hand: sudo rpm -Uvh $(pwd)/$rpm" && \
	exit 1
fi

%build
mysql_source=../mysql-%{mysql_version}/mysql-%{mysql_version}
if [ ! -d ${mysql_source} ]; then
    MYSQL_RPMBUILD_TEST=no rpmbuild -bp \
        --define 'optflags -O0' \
	../../SPECS/mysql.%{mysql_version}.spec
fi
%configure --with-mysql-source=${mysql_source}
make %{?_smp_mflags}


%install
rm -rf $RPM_BUILD_ROOT
make install DESTDIR=$RPM_BUILD_ROOT
rm $RPM_BUILD_ROOT%{_libdir}/mysql/plugin/*.la
rm $RPM_BUILD_ROOT%{_libdir}/mysql/plugin/ha_groonga.a
mv $RPM_BUILD_ROOT%{_datadir}/groonga-storage-engine/ \
    $RPM_BUILD_ROOT%{_datadir}/mysql-groonga/

%clean
rm -rf $RPM_BUILD_ROOT

%post
if [ $1 -eq 1 ]; then
    sql="
INSTALL PLUGIN groonga SONAME 'ha_groonga.so';
CREATE FUNCTION last_insert_grn_id RETURNS INTEGER soname 'ha_groonga.so';
"
    command="/usr/bin/mysql -u root -e \"$sql\""
    echo $command
    eval $command || \
	(echo "run the following command to register groonga storage engine:"; \
	 echo "  $command")
fi

%postun
if [ $1 -eq 0 ]; then
  sql="
DROP FUNCTION last_insert_grn_id;
UNINSTALL PLUGIN groonga;
"
  command="/usr/bin/mysql -u root -e \"$sql\""
  echo $command
  eval $command || \
      (echo "run the following command to unregister groonga storage engine:"; \
       echo "  $command")
fi

%files
%defattr(-,root,root,-)
%{_libdir}/mysql/plugin/
%doc %{_datadir}/mysql-groonga/doc/

%changelog
* Wed Jun 29 2011 Kouhei Sutou <kou@clear-code.com> - 0.7-0
- new upstream release.

* Sun May 29 2011 Kouhei Sutou <kou@clear-code.com> - 0.6-0
- new upstream release.

* Thu May 17 2011 Kouhei Sutou <kou@clear-code.com> - 0.5-2
- use MySQL 5.5.12.

* Thu Mar 29 2011 Kouhei Sutou <kou@clear-code.com> - 0.5-1
- new upstream release.

* Sat Jan 29 2011 Kouhei Sutou <kou@clear-code.com> - 0.4-4
- do not remove plugin on upgrade.

* Wed Jan 12 2011 Kouhei Sutou <kou@clear-code.com> - 0.4-3
- rebuild without debug symbol.

* Thu Dec 30 2010 Kouhei Sutou <kou@clear-code.com> - 0.4-2
- use MySQL 5.5.8-1.
- fix SQL literal notation.

* Mon Nov 29 2010 Kouhei Sutou <kou@clear-code.com> - 0.4-1
- use the latest MySQL.
- new upstream release.

* Sun Nov 21 2010 Kouhei Sutou <kou@clear-code.com> - 0.3-2
- install user define function.

* Fri Oct 29 2010 Kouhei Sutou <kou@clear-code.com> - 0.3-1
- new upstream release.

* Fri Oct 08 2010 Kouhei Sutou <kou@clear-code.com> - 0.2-2
- specify target MySQL version.
- use %{version}.

* Wed Sep 29 2010 Kouhei Sutou <kou@clear-code.com> - 0.2-1
- new upstream release.

* Wed Sep 12 2010 Kouhei Sutou <kou@clear-code.com> - 0.1-3
- require MySQL-client-community.

* Fri Sep 10 2010 Kouhei Sutou <kou@clear-code.com> - 0.1-2
- use MySQL-devel-community.

* Fri Sep 03 2010 Kouhei Sutou <kou@clear-code.com> - 0.1-1
- initial packaging for CentOS.
