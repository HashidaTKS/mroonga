%define mysql_version 5.1.50
%define mysql_release 1
%define mysql_dist    rhel5

Name:		mysql-groonga
Version:	@VERSION@
Release:	1%{?dist}
Summary:	A MySQL storage engine powered by groonga.

Group:		Applications/Databases
License:	BSD
URL:		http://mroonga.github.com/
Source0:	http://github.com/downloads/mroonga/mroonga/groonga-storage-engine-@VERSION@.tar.gz

BuildRoot:      %{_tmppath}/%{name}-%{version}-%{release}-%(%{__id_u} -n)
BuildRequires:	groonga-devel
BuildRequires:	wget
Requires:	groonga-libs
Requires:	MySQL-server-community
Conflicts:      mysql-server

%description
Groonga storage engine is a MySQL storage plugin.

%prep
%setup -q -n groonga-storage-engine-@VERSION@
srpm=MySQL-community-%{mysql_version}-%{mysql_release}.%{mysql_dist}.src.rpm
if [ ! -f ../../SRPMS/$srpm ]; then
    mysql_download_base=http://ftp.jaist.ac.jp/pub/mysql/Downloads/MySQL-5.1
    wget -O ../../SRPMS/$srpm $mysql_download_base/$srpm
    rpm -Uvh ../../SRPMS/$srpm
    for package in client devel embedded server shared test; do
        rpm=MySQL-${package}-community-%{mysql_version}-%{mysql_release}.%{mysql_dist}.%{_arch}.rpm
	mkdir -p ../../RPMS/%{_arch}
	if [ ! -f ../../RPMS/%{_arch}/$rpm ]; then
            wget -O ../../RPMS/%{_arch}/$rpm $mysql_download_base/$rpm
	fi
    done
fi

%build
if [ ! -d ../mysql-%{mysql_version} ]; then
    MYSQL_RPMBUILD_TEST=no rpmbuild -bc \
        --define 'community 1' --define 'optflags -O0' \
	../../SPECS/mysql-%{mysql_version}.%{mysql_dist}.spec
fi
%configure --with-mysql=../mysql-%{mysql_version}
make %{?_smp_mflags}


%install
rm -rf $RPM_BUILD_ROOT
make install DESTDIR=$RPM_BUILD_ROOT
rm $RPM_BUILD_ROOT%{_libdir}/mysql/plugin/*.la
rm $RPM_BUILD_ROOT%{_libdir}/mysql/plugin/ha_groonga.a

%clean
rm -rf $RPM_BUILD_ROOT

%post
echo "INSTALL PLUGIN groonga SONAME 'ha_groonga.so';" | mysql -u root mysql

%postun
echo "INSTALL PLUGIN groonga SONAME 'ha_groonga.so';" | mysql -u root mysql

%files
%defattr(-,root,root,-)
%{_libdir}/mysql/plugin/

%changelog
* Fri Sep 03 2010 Kouhei Sutou <kou@clear-code.com> - 0.1-1
- initial packaging for Fedora
