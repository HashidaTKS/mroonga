%define mysql_version 5.1.51
%define mysql_release 2%{?dist}

Name:		mysql-groonga
Version:	@VERSION@
Release:	1%{?dist}
Summary:	A MySQL storage engine powered by groonga.

Group:		Applications/Databases
License:	LGPLv2.1
URL:		http://mroonga.github.com/
Source0:	http://github.com/downloads/mroonga/mroonga/groonga-storage-engine-%{version}.tar.gz

BuildRequires:	groonga-devel
BuildRequires:	mysql-devel
Requires:	groonga-libs
Requires:	mysql-server
Requires:	mysql-client

%description
Groonga storage engine is a MySQL storage plugin.

%prep
%setup -q -n groonga-storage-engine-%{version}
srpm=mysql-%{mysql_version}-%{mysql_release}.src.rpm
if [ ! -f ../../SRPMS/$srpm ]; then
    curl --output ../../SRPMS/$srpm \
	http://ftp.iij.ad.jp/pub/linux/fedora/releases/14/Everything/source/SRPMS/$srpm
    rpm -Uvh ../../SRPMS/$srpm
fi

%build
if [ ! -d ../mysql-%{mysql_version} ]; then
    rpmbuild -bp --define 'runselftest 0' --define 'optflags -O0' \
        ../../SPECS/mysql.spec
fi
%configure --with-mysql-source=../mysql-%{mysql_version}
make %{?_smp_mflags}


%install
rm -rf $RPM_BUILD_ROOT
make install DESTDIR=$RPM_BUILD_ROOT
rm $RPM_BUILD_ROOT%{_libdir}/mysql/plugin/*.la
rm $RPM_BUILD_ROOT%{_libdir}/mysql/plugin/ha_groonga.a

%clean
rm -rf $RPM_BUILD_ROOT

%post
sql=<<EOS
INSTALL PLUGIN groonga SONAME 'ha_groonga.so';
CREATE FUNCTION last_insert_grn_id RETURNS INTEGER soname 'ha_groonga.so';
EOS
command="/usr/bin/mysql -u root -p -e \"$sql\""
echo $command
eval $command || \
    (echo "run the following command to register groonga storage engine:"; \
     echo "  $command")

%postun
sql=<<EOS
DROP FUNCTION last_insert_grn_id;
UNINSTALL PLUGIN groonga;
EOS
command="/usr/bin/mysql -u root -p -e \"$sql\""
echo $command
eval $command || \
    (echo "run the following command to unregister groonga storage engine:"; \
     echo "  $command")

%files
%defattr(-,root,root,-)
%{_libdir}/mysql/plugin/

%changelog
* Mon Nov 29 2010 Kouhei Sutou <kou@clear-code.com> - 0.4-1
- use the latest MySQL.
- new upstream release.

* Sun Nov 21 2010 Kouhei Sutou <kou@clear-code.com> - 0.3-2
- install user define function.

* Fri Oct 29 2010 Kouhei Sutou <kou@clear-code.com> - 0.3-1
- new upstream release.

* Fri Oct 08 2010 Kouhei Sutou <kou@clear-code.com> - 0.2-2
- use %{version}.

* Wed Sep 29 2010 Kouhei Sutou <kou@clear-code.com> - 0.2-1
- new upstream release.

* Wed Sep 12 2010 Kouhei Sutou <kou@clear-code.com> - 0.1-3
- require mysql-client.

* Fri Sep 10 2010 Kouhei Sutou <kou@clear-code.com> - 0.1-2
- follow configure option changes.

* Fri Sep 03 2010 Kouhei Sutou <kou@clear-code.com> - 0.1-1
- initial packaging for Fedora.
